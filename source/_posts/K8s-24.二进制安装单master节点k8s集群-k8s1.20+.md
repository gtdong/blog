**韩先超老师微信:****luckylucky421302** 二进制安装单 master 单 node 测试环境 k8s 集群

加我微信可进技术群学习交流-获取最新课件资料 微信号:

```
luckylucky421302
也可通过扫描下面二维码添加
课程更新的知识点会通过微信公众号免费分享给大家，可以关注我的公众号
```

推荐课程如下:
 Docker+kubernetes(k8s)+DevOps 企业级架构师实战培训 https://edu.51cto.com/course/27936.html

kubernetes/k8s+SpringCloud 全栈技术:基于世界 500 强的企业实战课程

https://edu.51cto.com/course/26635.html

Pod 网段: 10.0.0.0/16 Service网段: 10.255.0.0/16

```
讲师:先超
 实验环境规划:
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

操作系统:centos7.6
 配置: 4Gib 内存/4vCPU/100G 硬盘 网络:NAT
 开启虚拟机的虚拟化:

K8S 集群角 Ip 主机名 色

工作节点 192.168.40.181 xianchaonode1

kubeadm 和二进制安装 k8s 适用场景分析

安装的组件

kubelet、kube-proxy、docker、calico、cordns

| 控制节点 | `192.168.40.180 ` | `xianchaomaster1 ` | apiserver、controller-manager、scheduler、etcd、 docker |
| -------- | ----------------- | ------------------ | ------------------------------------------------------- |
|          |                   |                    |                                                         |

kubeadm 是官方提供的开源工具，是一个开源项目，用于快速搭建 kubernetes 集群，目前是比较方 便和推荐使用的。kubeadm init 以及 kubeadm join 这两个命令可以快速创建 kubernetes 集群。Kubeadm 初始化 k8s，所有的组件都是以 pod 形式运行的，具备故障自恢复能力。

kubeadm 是工具，可以快速搭建集群，也就是相当于用程序脚本帮我们装好了集群，属于自动部署， 简化部署操作，自动部署屏蔽了很多细节，使得对各个模块感知很少，如果对 k8s 架构组件理解不深的话， 遇到问题比较难排查。

kubeadm 适合需要经常部署 k8s，或者对自动化要求比较高的场景下使用。

二进制:在官网下载相关组件的二进制包，如果手动安装，对 kubernetes 理解也会更全面。

Kubeadm 和二进制都适合生产环境，在生产环境运行都很稳定，具体如何选择，可以根据实际项目进 行评估。

1.初始化安装 k8s 集群的实验环境

1.1 配置静态 IP

把虚拟机或者物理机配置成静态 ip 地址，这样机器重新启动后 ip 地址也不会发生改变。 修改 xianchaomaster1 主机的静态 IP:

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

修改/etc/sysconfig/network-scripts/ifcfg-ens33 文件，变成如下: TYPE=Ethernet
 PROXY_METHOD=none
 BROWSER_ONLY=no

```
    BOOTPROTO=static
    IPADDR=192.168.40.180
    NETMASK=255.255.255.0
    GATEWAY=192.168.40.2
    DNS1=192.168.40.2
    DEFROUTE=yes
    IPV4_FAILURE_FATAL=no
    IPV6INIT=yes
    IPV6_AUTOCONF=yes
    IPV6_DEFROUTE=yes
    IPV6_FAILURE_FATAL=no
    IPV6_ADDR_GEN_MODE=stable-privacy
    NAME=ens33
    DEVICE=ens33
    ONBOOT=yes
```

\#修改配置文件之后需要重启网络服务才能使配置生效，重启网络服务命令如下: service network restart

把虚拟机或者物理机配置成静态 ip 地址，这样机器重新启动后 ip 地址也不会发生改变。 修改 xianchaonode1 主机的静态 IP: 修改/etc/sysconfig/network-scripts/ifcfg-ens33 文件，变成如下:
 TYPE=Ethernet

```
    PROXY_METHOD=none
    BROWSER_ONLY=no
    BOOTPROTO=static
    IPADDR=192.168.40.181
    NETMASK=255.255.255.0
    GATEWAY=192.168.40.2
    DNS1=192.168.40.2
    DEFROUTE=yes
    IPV4_FAILURE_FATAL=no
    IPV6INIT=yes
    IPV6_AUTOCONF=yes
    IPV6_DEFROUTE=yes
    IPV6_FAILURE_FATAL=no
    IPV6_ADDR_GEN_MODE=stable-privacy
    NAME=ens33
    DEVICE=ens33
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

ONBOOT=yes

\#修改配置文件之后需要重启网络服务才能使配置生效，重启网络服务命令如下: service network restart

注:/etc/sysconfig/network-scripts/ifcfg-ens33 文件里的配置说明:
 NAME=ens33 #网卡名字，跟 DEVICE 名字保持一致即可
 DEVICE=ens33 #网卡设备名，大家 ip addr 可看到自己的这个网卡设备名，每个人的机器可能这个

名字不一样，需要写自己的
 BOOTPROTO=static #static 表示静态 ip 地址
 ONBOOT=yes #开机自启动网络，必须是 yes
 IPADDR=192.168.40.180 #ip 地址，需要跟自己电脑所在网段一致 NETMASK=255.255.255.0 #子网掩码，需要跟自己电脑所在网段一致 GATEWAY=192.168.40.2 #网关，在自己电脑打开 cmd，输入 ipconfig /all 可看到 DNS1=192.168.40.2 #DNS，在自己电脑打开 cmd，输入 ipconfig /all 可看到

1.2

1.3

1.4

1.5

1.6

配置主机名
 配置主机名:
 在 192.168.40.180 上执行如下:
 hostnamectl set-hostname xianchaomaster1 && bash 在 192.168.40.181 上执行如下:
 hostnamectl set-hostname xianchaonode1 && bash

配置hosts文件
 修改每台机器的/etc/hosts 文件，增加如下两行: 192.168.40.180 xianchaomaster1 192.168.40.181 xianchaonode1

配置主机之间无密码登录
 生成 ssh 密钥对
 [root@xianchaomaster1 ~]# ssh-keygen -t rsa
 \#一路回车，不输入密码
 把本地的 ssh 公钥文件安装到远程主机对应的账户
 [root@xianchaomaster1 ~]# ssh-copy-id -i .ssh/id_rsa.pub xianchaomaster1 [root@xianchaomaster1 ~]# ssh-copy-id -i .ssh/id_rsa.pub xianchaonode1

关闭firewalld防火墙
 [root@xianchaomaster1 ~]# systemctl stop firewalld ; systemctl disable firewalld [root@xianchaonode1 ~]# systemctl stop firewalld ; systemctl disable firewalld

关闭selinux
 [root@xianchaomaster1~]# sed -i 's/SELINUX=enforcing/SELINUX=disabled/g'

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

/etc/selinux/config
 \#修改 selinux 配置文件之后，重启机器，selinux 才能永久生效 [root@xianchaomaster1 ~]# getenforce
 Disabled
 [root@xianchaonode1 ~]# sed -i 's/SELINUX=enforcing/SELINUX=disabled/g'

/etc/selinux/config
 \#修改 selinux 配置文件之后，重启机器，selinux 才能永久生效 [root@xianchaonode1 ~]# getenforce
 Disabled

1.7 关闭交换分区swap [root@xianchaomaster1 ~]# swapoff -a [root@xianchaonode1 ~]# swapoff -a

永久关闭:注释 swap 挂载，给 swap 这行开头加一下注释 #删除 UUID
 [root@xianchaomaster1 ~]# vim /etc/fstab #/dev/mapper/centos-swap swap swap [root@xianchaonode1 ~]# vim /etc/fstab #/dev/mapper/centos-swap swap swap defaults

1.8 修改内核参数
 [root@xianchaomaster1 ~]# modprobe br_netfilter
 [root@xianchaomaster1 ~]# echo "modprobe br_netfilter" >> /etc/profile [root@xianchaomaster1~]# cat > /etc/sysctl.d/k8s.conf <<EOF net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1
 net.ipv4.ip_forward = 1
 EOF
 [root@xianchaomaster1 ~]# sysctl -p /etc/sysctl.d/k8s.conf

```
    [root@xianchaonode1 ~]#  modprobe br_netfilter
    [root@xianchaonode1 ~]#  echo "modprobe br_netfilter" >> /etc/profile
    [root@xianchaonode1~]#  cat > /etc/sysctl.d/k8s.conf <<EOF
    net.bridge.bridge-nf-call-ip6tables = 1
    net.bridge.bridge-nf-call-iptables = 1
    net.ipv4.ip_forward = 1
    EOF
    [root@xianchaonode1 ~]# sysctl -p /etc/sysctl.d/k8s.conf
```

1.9 配置阿里云 repo 源
 在 xianchaomaster1 上操作:

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

defaults

0 0 0 0

**韩先超老师微信:****luckylucky421302**

安装 rzsz 命令

```
    [root@xianchaomaster1]# yum install lrzsz -y
```

安装 scp 命令:

```
    [root@xianchaomaster1]#yum install openssh-clients
```

\#备份基础 repo 源

```
    [root@xianchaomaster1 ~]# mkdir /root/repo.bak
    [root@xianchaomaster1 ~]# cd /etc/yum.repos.d/
    [root@xianchaomaster1]# mv * /root/repo.bak/
```

\#下载阿里云的 repo 源

把 CentOS-Base.repo 文件上传到 xianchaomaster1 主机的/etc/yum.repos.d/目录下

在 xianchaonode1 上操作:

安装 rzsz 命令

```
    [root@xianchaonode1]# yum install lrzsz -y
```

安装 scp:

```
    [root@xianchaonode1]#yum install openssh-clients
```

\#备份基础 repo 源

```
    [root@ xianchaonode1 ~]# mkdir /root/repo.bak
    [root@ xianchaonode1 ~]# cd /etc/yum.repos.d/
    [root@ xianchaonode1]# mv * /root/repo.bak/
```

\#下载阿里云的 repo 源

把 CentOS-Base.repo 文件上传到 xianchaonode1 主机的/etc/yum.repos.d/目录下

\#配置国内阿里云 docker 的 repo 源

```
    [root@xianchaomaster1 ~]# yum-config-manager --add-repo
http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
    [root@xianchaonode1 ~]# yum-config-manager --add-repo http://mirrors.aliyun.com/docker-
ce/linux/centos/docker-ce.repo
```

\#配置 epel 源

把 epel.repo 上传到 xianchaomaster1 的/etc/yum.repos.d 目录下，然后再远程拷贝到 xianchaonode1 节点。

```
     [root@xianchaomaster1 ~]# scp /etc/yum.repos.d/epel.repo
 xianchaonode1:/etc/yum.repos.d/
```

1.10 配置时间同步

[root@xianchaomaster1 ~]# yum install ntpdate -y

[root@xianchaomaster1 ~]# ntpdate cn.pool.ntp.org #把时间同步做成计划任务

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

[root@xianchaomaster1 ~]# crontab -e
 \* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org #重启 crond 服务
 [root@xianchaomaster1 ~]# service crond restart

[root@xianchaonode1 ~]# yum install ntpdate -y [root@xianchaonode1~]# ntpdate cn.pool.ntp.org #把时间同步做成计划任务
 [root@xianchaonode1 ~]# crontab -e

\* */1 * * * /usr/sbin/ntpdate cn.pool.ntp.org #重启 crond 服务
 [root@xianchaonode1 ~]# service crond restart

1.11 安装 iptables
 如果用 firewalld 不是很习惯，可以安装 iptables
 [root@xianchaomaster1 ~]# yum install iptables-services -y
 禁用 iptables
 [root@xianchaomaster1 ~]# service iptables stop && systemctl disable iptables 清空防火墙规则
 [root@xianchaomaster1 ~]# iptables -F

如果用 firewalld 不是很习惯，可以安装 iptables
 [root@xianchaonode1 ~]# yum install iptables-services -y
 禁用 iptables
 [root@xianchaonode1 ~]# service iptables stop && systemctl disable iptables 清空防火墙规则
 [root@xianchaonode1 ~]# iptables -F

1.12 开启 ipvs
 \#不开启 ipvs 将会使用 iptables 进行数据包转发，但是效率低，所以官网推荐需要开通 ipvs。 #把 ipvs.modules 上传到 xianchaomaster1 机器的/etc/sysconfig/modules/目录下 [root@xianchaomaster1# chmod 755 /etc/sysconfig/modules/ipvs.modules && bash

```
/etc/sysconfig/modules/ipvs.modules && lsmod | grep ip_vs
    ip_vs_ftp
    nf_nat
    ip_vs_sed
    ip_vs_nq
    ip_vs_sh
    ip_vs_dh
    [root@xianchaomaster1~]# scp /etc/sysconfig/modules/ipvs.modules
xianchaonode1:/etc/sysconfig/modules/
    [root@xianchaonode1]# chmod 755 /etc/sysconfig/modules/ipvs.modules && bash
/etc/sysconfig/modules/ipvs.modules && lsmod | grep ip_vs
    ip_vs_ftp              13079  0
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
13079  0
26583  1 ip_vs_ftp
12519  0
12516  0
12688  0
12688  0
nf_nat
ip_vs_sed
ip_vs_nq
ip_vs_sh
ip_vs_dh
26583  1 ip_vs_ftp
12519  0
12516  0
12688  0
```

12688 0

**韩先超老师微信:****luckylucky421302**

1.13 安装基础软件包
 [root@xianchaomaster1 modules]# yum install -y yum-utils device-mapper-persistent-data

lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python-devel epel-release openssh-server socat ipvsadm conntrack ntpdate

[root@xianchaonode1 ~]# yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel python- devel epel-release openssh-server socat ipvsadm conntrack ntpdate

1.14 安装 docker-ce
 [root@xianchaomaster1~]# yum install docker-ce docker-ce-cli containerd.io -y [root@xianchaomaster1~]# systemctl start docker && systemctl enable docker.service [root@xianchaonode1 ~]# yum install docker-ce docker-ce-cli containerd.io -y [root@xianchaonode1~]# systemctl start docker && systemctl enable docker.service

1.15 配置 docker 镜像加速器
 [root@xianchaomaster1~]# tee /etc/docker/daemon.json << 'EOF' {

"registry-mirrors":["https://rsbud4vc.mirror.aliyuncs.com","https://registry.docker- cn.com","https://docker.mirrors.ustc.edu.cn","https://dockerhub.azk8s.cn","http://hub- mirror.c.163.com","http://qtid6917.mirror.aliyuncs.com", "https://rncxm540.mirror.aliyuncs.com"],

```
      "exec-opts": ["native.cgroupdriver=systemd"]
    }
    EOF
    [root@xianchaomaster1~]# systemctl daemon-reload
    [root@xianchaomaster1~]# systemctl restart docker
    [root@xianchaomaster1 ~]# systemctl status docker
```

Active: active (running) since Wed 2021-04-21 11:37:45 CST; 25s ago
 \#修改 docker 文件驱动为 systemd，默认为 cgroupfs，kubelet 默认使用 systemd，两者必须一致才可

以。

```
    [root@xianchaonode1~]# tee /etc/docker/daemon.json << 'EOF'
    {
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

"registry-mirrors":["https://rsbud4vc.mirror.aliyuncs.com","https://registry.docker- cn.com","https://docker.mirrors.ustc.edu.cn","https://dockerhub.azk8s.cn","http://hub- mirror.c.163.com","http://qtid6917.mirror.aliyuncs.com", "https://rncxm540.mirror.aliyuncs.com"],

```
      "exec-opts": ["native.cgroupdriver=systemd"]
    }
    EOF
    [root@xianchaonode1~]# systemctl daemon-reload
    [root@xianchaonode1~]# systemctl restart docker
    [root@xianchaonode1 ~]# systemctl status docker
       Active: active (running) since Wed 2021-04-21 11:37:45 CST; 25s ago
```

2.搭建 etcd 集群

2.1 配置etcd工作目录 #创建配置文件目录和证书文件存放目录 [root@xianchaomaster1 ~]# mkdir -p /etc/etcd [root@xianchaomaster1 ~]# mkdir -p /etc/etcd/ssl

2.2 安装签发证书工具cfssl
 [root@xianchaomaster1 ~]# mkdir /data/work -p
 [root@xianchaomaster1 ~]# cd /data/work/
 \#把cfssl-certinfo_linux-amd64 cfssljson_linux-amd64 cfssl_linux-amd64上传到目录 [root@xianchaomaster1 work]# ls
 cfssl-certinfo_linux-amd64 cfssljson_linux-amd64 cfssl_linux-amd64 #把文件变成可执行权限
 [root@xianchaomaster1 work]# chmod +x *
 [root@xianchaomaster1 work]# mv cfssl_linux-amd64 /usr/local/bin/cfssl [root@xianchaomaster1 work]# mv cfssljson_linux-amd64 /usr/local/bin/cfssljson [root@xianchaomaster1 work]# mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo

2.3 配置ca证书

\#生成 ca 证书请求文件
 [root@xianchaomaster1 work]# cd /data/work/ [root@xianchaomaster1 work]# vim ca-csr.json {

```
      "CN": "kubernetes",
      "key": {
          "algo": "rsa",
          "size": 2048
      },
```

"names": [

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

```
        {
          "C": "CN",
          "ST": "Hubei",
          "L": "Wuhan",
          "O": "k8s",
          "OU": "system"
```

} ],

```
      "ca": {
              "expiry": "87600h"
```

} }

[root@xianchaomaster1 work]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca

注: CN:Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name);浏览 器使用该字段验证网站是否合法; O:Organization，kube-apiserver 从证书中提取该字段作为请求用户 所属的组 (Group)

\#生成 ca 证书 json 文件

[root@xianchaomaster1 work]# vim ca-config.json {

```
      "signing": {
          "default": {
              "expiry": "87600h"
            },
          "profiles": {
              "kubernetes": {
                  "usages": [
                      "signing",
                      "key encipherment",
                      "server auth",
                      "client auth"
```

],

```
                  "expiry": "87600h"
              }
```

} }

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

}

**韩先超老师微信:****luckylucky421302**

2.4 生成 etcd 证书
 \#配置 etcd 证书请求，hosts 的 ip 变成自己 master 节点的 ip [root@xianchaomaster1 work]# vim etcd-csr.json
 {

```
      "CN": "etcd",
      "hosts": [
        "127.0.0.1",
        "192.168.40.180"
      ],
      "key": {
        "algo": "rsa",
        "size": 2048
      },
      "names": [{
        "C": "CN",
        "ST": "Hubei",
        "L": "Wuhan",
        "O": "k8s",
        "OU": "system"
```

}] }

[root@xianchaomaster1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca- config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd

```
    [root@xianchaomaster1 work]# ls etcd*.pem
    etcd-key.pem  etcd.pem
```

2.5 部署 etcd 集群
 把 etcd-v3.4.13-linux-amd64.tar.gz 上传到 xianchaomaster1 节点的/data/work 目录下 [root@xianchaomaster1 work]# pwd
 /data/work
 [root@xianchaomaster1 work]# tar -xf etcd-v3.4.13-linux-amd64.tar.gz [root@xianchaomaster1 work]# cp -p etcd-v3.4.13-linux-amd64/etcd* /usr/local/bin/ #创建配置文件
 [root@xianchaomaster1 work]# cd /data/work/
 [root@xianchaomaster1 work]# vim etcd.conf
 \#[Member]
 ETCD_NAME="etcd1"
 ETCD_DATA_DIR="/var/lib/etcd/default.etcd"

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

```
    ETCD_LISTEN_PEER_URLS="https://192.168.40.180:2380"
    ETCD_LISTEN_CLIENT_URLS="https://192.168.40.180:2379,http://127.0.0.1:2379"
    #[Clustering]
    ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.40.180:2380"
    ETCD_ADVERTISE_CLIENT_URLS="https://192.168.40.180:2379"
    ETCD_INITIAL_CLUSTER="etcd1=https://192.168.40.180:2380"
    ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"
    ETCD_INITIAL_CLUSTER_STATE="new"
```

\#注:

ETCD_NAME:节点名称，集群中唯一 ETCD_DATA_DIR:数据目录 ETCD_LISTEN_PEER_URLS:集群通信监听地址 ETCD_LISTEN_CLIENT_URLS:客户端访问监听地址 ETCD_INITIAL_ADVERTISE_PEER_URLS:集群通告地址 ETCD_ADVERTISE_CLIENT_URLS:客户端通告地址 ETCD_INITIAL_CLUSTER:集群节点地址 ETCD_INITIAL_CLUSTER_TOKEN:集群 Token

ETCD_INITIAL_CLUSTER_STATE:加入集群的当前状态，new 是新集群，existing 表示加入已有集群

\#创建启动服务文件
 [root@xianchaomaster1 work]# vim etcd.service [Unit]
 Description=Etcd Server
 After=network.target After=network-online.target Wants=network-online.target

```
    [Service]
    Type=notify
    EnvironmentFile=-/etc/etcd/etcd.conf
    WorkingDirectory=/var/lib/etcd/
    ExecStart=/usr/local/bin/etcd \
      --cert-file=/etc/etcd/ssl/etcd.pem \
      --key-file=/etc/etcd/ssl/etcd-key.pem \
      --trusted-ca-file=/etc/etcd/ssl/ca.pem \
      --peer-cert-file=/etc/etcd/ssl/etcd.pem \
      --peer-key-file=/etc/etcd/ssl/etcd-key.pem \
      --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \
      --peer-client-cert-auth \
      --client-cert-auth
    Restart=on-failure
    RestartSec=5
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
LimitNOFILE=65536
```

**韩先超老师微信:****luckylucky421302**

```
    [Install]
    WantedBy=multi-user.target
```

[root@xianchaomaster1 work]# cp ca*.pem /etc/etcd/ssl/ [root@xianchaomaster1 work]# cp etcd*.pem /etc/etcd/ssl/ [root@xianchaomaster1 work]# cp etcd.conf /etc/etcd/ [root@xianchaomaster1 work]# cp etcd.service /usr/lib/systemd/system/ [root@xianchaomaster1 work]# mkdir -p /var/lib/etcd/default.etcd #启动 etcd 集群

```
    [root@xianchaomaster1 work]# systemctl daemon-reload
    [root@xianchaomaster1 work]# systemctl enable etcd.service
    [root@xianchaomaster1 work]# systemctl start etcd.service
    [root@xianchaomaster1 work]# systemctl status etcd
    Active: active (running) since Wed 2021-04-21 17:53:46 CST; 8ms ago
```

\#查看 etcd 集群
 [root@xianchaomaster1 work]# ETCDCTL_API=3
 [root@xianchaomaster1 work]# /usr/local/bin/etcdctl --write-out=table --

cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem - -endpoints=https://192.168.40.180:2379 endpoint health

+-----------------------------+--------+-------------+-------+ | ENDPOINT | HEALTH | TOOK | ERROR | +-----------------------------+--------+-------------+-------+ | https://192.168.40.180:2379 | true | 44.271061ms | |

3.安装 kubernetes 组件

二进制包所在的 github 地址如下:

```
     https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/
```

3.1 下载安装包
 \#把 kubernetes-server-linux-amd64.tar.gz 上传到 xianchaomaster1 上的/data/work [root@xianchaomaster1 work]# tar zxvf kubernetes-server-linux-amd64.tar.gz [root@xianchaomaster1 work]# cd kubernetes/server/bin/
 [root@xianchaomaster1 bin]# cp kube-apiserver kube-controller-manager kube-scheduler

kubectl /usr/local/bin/
 [root@xianchaomaster1 bin]# scp kubelet kube-proxy xianchaonode1:/usr/local/bin/ [root@xianchaomaster1 bin]# cd /data/work/
 [root@xianchaomaster1 work]# mkdir -p /etc/kubernetes/
 [root@xianchaomaster1 work]# mkdir -p /etc/kubernetes/ssl

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302** [root@xianchaomaster1 work]# mkdir /var/log/kubernetes

3.2 部署 api-server 组件

\#启动 TLS Bootstrapping 机制

Master apiserver 启用 TLS 认证后，每个节点的 kubelet 组件都要使用由 apiserver 使用的 CA 签 发的有效证书才能与 apiserver 通讯，当 Node 节点很多时，这种客户端证书颁发需要大量工作，同样 也会增加集群扩展复杂度。

为了简化流程，Kubernetes引入了TLS bootstraping机制来自动颁发客户端证书，kubelet会以一 个低权限用户自动向 apiserver 申请证书，kubelet 的证书由 apiserver 动态签署。

Bootstrap 是很多系统中都存在的程序，比如 Linux 的 bootstrap，bootstrap 一般都是作为预先配 置在开启或者系统启动的时候加载，这可以用来生成一个指定环境。Kubernetes 的 kubelet 在启动时同 样可以加载一个这样的配置文件，这个文件的内容类似如下形式:

```
   apiVersion: v1
    clusters: null
    contexts:
    - context:
        cluster: kubernetes
        user: kubelet-bootstrap
      name: default
    current-context: default
    kind: Config
    preferences: {}
    users:
    - name: kubelet-bootstrap
      user: {}
```

\#TLS bootstrapping 具体引导过程

1.TLS 作用
 TLS 的作用就是对通讯加密，防止中间人窃听;同时如果证书不信任的话根本就无法与 apiserver 建立连接，更不用提有没有权限向 apiserver 请求指定内容。

\2. RBAC 作用
 当 TLS 解决了通讯问题后，那么权限问题就应由 RBAC 解决(可以使用其他权限模型，如 ABAC); RBAC 中规定了一个用户或者用户组(subject)具有请求哪些 api 的权限;在配合 TLS 加密的时候， 实际上 apiserver 读取客户端证书的 CN 字段作为用户名，读取 O 字段作为用户组.

以上说明:第一，想要与 apiserver 通讯就必须采用由 apiserver CA 签发的证书，这样才能形成 信任关系，建立 TLS 连接;第二，可以通过证书的 CN、O 字段来提供 RBAC 所需的用户与用户组。

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302
** TLS bootstrapping 功能是让 kubelet 组件去 apiserver 申请证书，然后用于连接 apiserver;

那么第一次启动时没有证书如何连接 apiserver ?

在apiserver配置中指定了一个 token.csv 文件，该文件中是一个预设的用户配置;同时该用 户的 Token 和 由 apiserver 的 CA 签发的用户被写入了 kubelet 所使用
 的 bootstrap.kubeconfig 配置文件中;这样在首次请求时，kubelet 使
 用 bootstrap.kubeconfig 中被 apiserver CA 签发证书时信任的用户来与 apiserver 建立 TLS 通讯，使用 bootstrap.kubeconfig 中的用户 Token 来向 apiserver 声明自己的 RBAC 授 权身份.

token.csv 格式: 3940fd7fbb391d1b4d861ad17a1f0613,kubelet-bootstrap,10001,"system:kubelet-bootstrap"

首次启动时，可能与遇到 kubelet 报 401 无权访问 apiserver 的错误;这是因为在默认情况 下，kubelet 通过 bootstrap.kubeconfig 中的预设用户 Token 声明了自己的身份，然后创建 CSR 请求;但是不要忘记这个用户在我们不处理的情况下他没任何权限的，包括创建 CSR 请求; 所以需要创建一个 ClusterRoleBinding，将预设用户 kubelet-bootstrap 与内置的 ClusterRole system:node-bootstrapper 绑定到一起，使其能够发起 CSR 请求。稍后安装 kubelet 的时候演示。

\#创建 token.csv 文件

```
     [root@xianchaomaster1 work]# cat > token.csv << EOF
     $(head -c 16 /dev/urandom | od -An -t x | tr -d ' '),kubelet-
 bootstrap,10001,"system:kubelet-bootstrap"
```

EOF #格式:token，用户名，UID，用户组

\#创建 csr 请求文件，替换为自己机器的 IP [root@xianchaomaster1 work]# vim kube-apiserver-csr.json {

```
      "CN": "kubernetes",
      "hosts": [
        "127.0.0.1",
        "192.168.40.180",
        "192.168.40.181",
        "10.255.0.1",
        "kubernetes",
        "kubernetes.default",
        "kubernetes.default.svc",
        "kubernetes.default.svc.cluster",
        "kubernetes.default.svc.cluster.local"
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

\#kubelet 首次启动流程

**韩先超老师微信:****luckylucky421302**

], "key": {

```
        "algo": "rsa",
        "size": 2048
      },
```

"names": [ {

```
          "C": "CN",
          "ST": "Hubei",
          "L": "Wuhan",
          "O": "k8s",
          "OU": "system"
```

} ]

}

\#注: 如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表。 由于该证书后续被 kubernetes master 集群使用，需要将master节点的IP都填上，同时还需要填写 service 网络的首个 IP。(一般是 kube-apiserver 指定的 service-cluster-ip-range 网段的第一个 IP，如 10.255.0.1)

\#生成证书和 token 文件

[root@xianchaomaster1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca- config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver

```
    [root@xianchaomaster1 work]# cat > token.csv << EOF
    $(head -c 16 /dev/urandom | od -An -t x | tr -d ' '),kubelet-
bootstrap,10001,"system:kubelet-bootstrap"
```

EOF

\#创建 api-server 的配置文件，替换成自己的 ip [root@xianchaomaster1 work]# vim kube-apiserver.conf KUBE_APISERVER_OPTS="--enable-admission-

plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,Re sourceQuota \

```
      --anonymous-auth=false \
      --bind-address=192.168.40.180 \
      --secure-port=6443 \
      --advertise-address=192.168.40.180 \
      --insecure-port=0 \
      --authorization-mode=Node,RBAC \
      --runtime-config=api/all=true \
      --enable-bootstrap-token-auth \
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

```
      --service-cluster-ip-range=10.255.0.0/16 \
      --token-auth-file=/etc/kubernetes/token.csv \
      --service-node-port-range=30000-50000 \
      --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \
      --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \
      --client-ca-file=/etc/kubernetes/ssl/ca.pem \
      --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \
      --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \
      --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \
      --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \
      --service-account-issuer=https://kubernetes.default.svc.cluster.local \
      --etcd-cafile=/etc/etcd/ssl/ca.pem \
      --etcd-certfile=/etc/etcd/ssl/etcd.pem \
      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \
      --etcd-servers=https://192.168.40.180:2379 \
      --enable-swagger-ui=true \
      --allow-privileged=true \
      --apiserver-count=3 \
      --audit-log-maxage=30 \
      --audit-log-maxbackup=3 \
      --audit-log-maxsize=100 \
      --audit-log-path=/var/log/kube-apiserver-audit.log \
      --event-ttl=1h \
      --alsologtostderr=true \
      --logtostderr=false \
      --log-dir=/var/log/kubernetes \
      --v=4"
```

\#注:

--logtostderr:启用日志
 --v:日志等级
 --log-dir:日志目录
 --etcd-servers:etcd 集群地址
 --bind-address:监听地址
 --secure-port:https 安全端口 --advertise-address:集群通告地址 --allow-privileged:启用授权 --service-cluster-ip-range:Service 虚拟 IP 地址段 --enable-admission-plugins:准入控制模块 --authorization-mode:认证授权，启用 RBAC 授权和节点自管理 --enable-bootstrap-token-auth:启用 TLS bootstrap 机制 --token-auth-file:bootstrap token 文件

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

--service-node-port-range:Service nodeport 类型默认分配端口范围 --kubelet-client-xxx:apiserver 访问 kubelet 客户端证书 --tls-xxx-file:apiserver https 证书
 --etcd-xxxfile:连接 Etcd 集群证书 –

-audit-log-xxx:审计日志

\#创建服务启动文件
 [root@xianchaomaster1 work]# vim kube-apiserver.service [Unit]
 Description=Kubernetes API Server Documentation=https://github.com/kubernetes/kubernetes After=etcd.service
 Wants=etcd.service

```
    [Service]
    EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf
    ExecStart=/usr/local/bin/kube-apiserver $KUBE_APISERVER_OPTS
    Restart=on-failure
    RestartSec=5
    Type=notify
    LimitNOFILE=65536
    [Install]
    WantedBy=multi-user.target
```

[root@xianchaomaster1 work]# cp ca*.pem /etc/kubernetes/ssl [root@xianchaomaster1 work]# cp kube-apiserver*.pem /etc/kubernetes/ssl/ [root@xianchaomaster1 work]# cp token.csv /etc/kubernetes/ [root@xianchaomaster1 work]# cp kube-apiserver.conf /etc/kubernetes/ [root@xianchaomaster1 work]# cp kube-apiserver.service /usr/lib/systemd/system/ [root@xianchaomaster1 work]# systemctl daemon-reload
 [root@xianchaomaster1 work]# systemctl enable kube-apiserver [root@xianchaomaster1 work]# systemctl start kube-apiserver [root@xianchaomaster1 work]# systemctl status kube-apiserver

```
       Active: active (running) since Wed
```

[root@xianchaomaster1 work]# curl --insecure https://192.168.40.180:6443/ {

```
      "kind": "Status",
      "apiVersion": "v1",
      "metadata": {
```

},

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

```
      "status": "Failure",
      "message": "Unauthorized",
      "reason": "Unauthorized",
      "code": 401
```

}

看到上面这个表示 apiserver 正常启动了。 3.3 部署 kubectl 组件

\#创建 csr 请求文件
 [root@xianchaomaster1 work]# vim admin-csr.json {

```
      "CN": "admin",
      "hosts": [],
      "key": {
        "algo": "rsa",
        "size": 2048
      },
```

"names": [ {

```
          "C": "CN",
          "ST": "Hubei",
          "L": "Wuhan",
          "O": "system:masters",
          "OU": "system"
```

} ]

}

\#说明: 后续 kube-apiserver 使用 RBAC 对客户端(如 kubelet、kube-proxy、Pod)请求进行授权; kube-apiserver 预定义了一些 RBAC 使用的 RoleBindings，如 cluster-admin 将 Group system:masters 与 Role cluster-admin 绑定，该 Role 授予了调用 kube-apiserver 的所有 API 的权限; O指定该证书的 Group 为 system:masters，kubelet 使用该证书访问 kube-apiserver 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 system:masters， 所以被授予访问所有 API 的权限; 注: 这个 admin 证书，是将来生成管理员用的 kube config 配 置文件用的，现在我们一般建议使用RBAC 来对kubernetes 进行角色权限控制， kubernetes 将证 书中的CN 字段 作为User，O 字段作为 Group;"O": "system:masters", 必须是system:masters， 否则后面 kubectl create clusterrolebinding 报错。

[root@xianchaomaster1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca- config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin

[root@xianchaomaster1 work]# cp admin*.pem /etc/kubernetes/ssl/ #创建 kubeconfig 配置文件，比较重要

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

kubeconfig 为 kubectl 的配置文件，包含访问 apiserver 的所有信息，如 apiserver 地址、CA 证 书和自身使用的证书(这里如果报错找不到 kubeconfig 路径，请手动复制到相应路径下，没有则忽略)

1.设置集群参数

[root@xianchaomaster1 work]# kubectl config set-cluster kubernetes --certificate- authority=ca.pem --embed-certs=true --server=https://192.168.40.180:6443 -- kubeconfig=kube.config

2.设置客户端认证参数

```
    [root@xianchaomaster1 work]# kubectl config set-credentials admin --client-
certificate=admin.pem --client-key=admin-key.pem --embed-certs=true --kubeconfig=kube.config
```

3.设置上下文参数

[root@xianchaomaster1 work]# kubectl config set-context kubernetes --cluster=kubernetes - -user=admin --kubeconfig=kube.config

4.设置默认上下文

[root@xianchaomaster1 work]# kubectl config use-context kubernetes -- kubeconfig=kube.config

[root@xianchaomaster1 work]# mkdir ~/.kube -p
 [root@xianchaomaster1 work]# cp kube.config ~/.kube/config
 5.授权 kubernetes 证书访问 kubelet api 权限
 [root@xianchaomaster1 work]# kubectl create clusterrolebinding kube-apiserver:kubelet-

```
apis --clusterrole=system:kubelet-api-admin --user kubernetes
```

\#查看集群组件状态
 [root@xianchaomaster1 work]# kubectl cluster-info
 Kubernetes control plane is running at https://192.168.40.180:6443

[root@xianchaomaster1 work]# kubectl get componentstatuses Warning: v1 ComponentStatus is deprecated in v1.19+
 NAME STATUS

MESSAGE

ERROR
 scheduler Unhealthy Get "http://127.0.0.1:10251/healthz": dial tcp

127.0.0.1:10251: connect: connection refused
 controller-manager Unhealthy Get "http://127.0.0.1:10252/healthz": dial tcp

```
127.0.0.1:10252: connect: connection refused
    etcd-0               Healthy     {"health":"true"}
```

[root@xianchaomaster1 work]# kubectl get all --all-namespaces
 NAMESPACE NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE default service/kubernetes ClusterIP 10.255.0.1 <none> 443/TCP

\#配置 kubectl 子命令补全
 参考官方文档: https://v1-20.docs.kubernetes.io/zh/docs/tasks/tools/install-kubectl-linux/

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

[root@xianchaomaster1 work]# yum install -y bash-completion
 [root@xianchaomaster1 work]# source /usr/share/bash-completion/bash_completion [root@xianchaomaster1 work]# source <(kubectl completion bash) [root@xianchaomaster1 work]# kubectl completion bash > ~/.kube/completion.bash.inc [root@xianchaomaster1 work]# source '/root/.kube/completion.bash.inc' [root@xianchaomaster1 work]# source $HOME/.bash_profile

在文件 ~/.bashrc 中导入(source)补全脚本:
 [root@xianchaomaster1 work]# echo 'source <(kubectl completion bash)' >>~/.bashrc 将补全脚本添加到目录 /etc/bash_completion.d 中:
 [root@xianchaomaster1 work]# kubectl completion bash >/etc/bash_completion.d/kubectl 如果 kubectl 有关联的别名，你可以扩展 shell 补全来适配此别名: [root@xianchaomaster1 work]# echo 'alias k=kubectl' >>~/.bashrc
 [root@xianchaomaster1 work]# echo 'complete -F __start_kubectl k' >>~/.bashrc

3.4 部署部署 kube-controller-manager 组件
 \#创建 csr 请求文件
 [root@xianchaomaster1 work]# vim kube-controller-manager-csr.json {

```
        "CN": "system:kube-controller-manager",
        "key": {
            "algo": "rsa",
            "size": 2048
        },
        "hosts": [
          "127.0.0.1",
          "192.168.40.180"
```

], "names": [

```
          {
            "C": "CN",
            "ST": "Hubei",
            "L": "Wuhan",
            "O": "system:kube-controller-manager",
            "OU": "system"
```

} ]

}

注: hosts 列表包含所有 kube-controller-manager 节点 IP; CN 为 system:kube-controller- manager、O 为 system:kube-controller-manager，kubernetes 内置的 ClusterRoleBindings system:kube-controller-manager 赋予 kube-controller-manager 工作所需的权限

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

\#生成证书

[root@xianchaomaster1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca- config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube- controller-manager

\#创建 kube-controller-manager 的 kubeconfig
 1.设置集群参数
 [root@xianchaomaster1 work]# kubectl config set-cluster kubernetes --certificate-

```
authority=ca.pem --embed-certs=true --server=https://192.168.40.180:6443 --kubeconfig=kube-
controller-manager.kubeconfig
```

2.设置客户端认证参数

```
    [root@xianchaomaster1 work]# kubectl config set-credentials system:kube-controller-
manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-
manager-key.pem --embed-certs=true --kubeconfig=kube-controller-manager.kubeconfig
```

3.设置上下文参数

[root@xianchaomaster1 work]# kubectl config set-context system:kube-controller-manager - -cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=kube-controller- manager.kubeconfig

4.设置默认上下文

[root@xianchaomaster1 work]# kubectl config use-context system:kube-controller-manager - -kubeconfig=kube-controller-manager.kubeconfig

\#创建配置文件 kube-controller-manager.conf [root@xianchaomaster1 work]# vim kube-controller-manager.conf KUBE_CONTROLLER_MANAGER_OPTS="--port=0 \

```
      --secure-port=10252 \
      --bind-address=127.0.0.1 \
      --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \
      --service-cluster-ip-range=10.255.0.0/16 \
      --cluster-name=kubernetes \
      --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \
      --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \
      --allocate-node-cidrs=true \
      --cluster-cidr=10.0.0.0/16 \
      --experimental-cluster-signing-duration=87600h \
      --root-ca-file=/etc/kubernetes/ssl/ca.pem \
      --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \
      --leader-elect=true \
      --feature-gates=RotateKubeletServerCertificate=true \
      --controllers=*,bootstrapsigner,tokencleaner \
      --horizontal-pod-autoscaler-use-rest-clients=true \
      --horizontal-pod-autoscaler-sync-period=10s \
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

```
      --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \
      --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \
      --use-service-account-credentials=true \
      --alsologtostderr=true \
      --logtostderr=false \
      --log-dir=/var/log/kubernetes \
      --v=2"
```

\#创建启动文件
 [root@xianchaomaster1 work]# vim kube-controller-manager.service
 [Unit]
 Description=Kubernetes Controller Manager Documentation=https://github.com/kubernetes/kubernetes
 [Service]
 EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf ExecStart=/usr/local/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS Restart=on-failure
 RestartSec=5
 [Install]
 WantedBy=multi-user.target

\#启动服务
 [root@xianchaomaster1 work]# cp kube-controller-manager*.pem /etc/kubernetes/ssl/ [root@xianchaomaster1 work]# cp kube-controller-manager.kubeconfig /etc/kubernetes/ [root@xianchaomaster1 work]# cp kube-controller-manager.conf /etc/kubernetes/ [root@xianchaomaster1 work]# cp kube-controller-manager.service /usr/lib/systemd/system/ [root@xianchaomaster1 work]# systemctl daemon-reload
 [root@xianchaomaster1 work]# systemctl enable kube-controller-manager [root@xianchaomaster1 work]# systemctl start kube-controller-manager [root@xianchaomaster1 work]# systemctl status kube-controller-manager

```
       Active: active (running) since
```

3.5 部署 kube-scheduler 组件 #创建 csr 请求

```
    [root@xianchaomaster1 work]# vim kube-scheduler-csr.json
    {
        "CN": "system:kube-scheduler",
        "hosts": [
          "127.0.0.1",
          "192.168.40.180"
        ],
        "key": {
            "algo": "rsa",
```

"size": 2048

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

}, "names": [

```
          {
            "C": "CN",
            "ST": "Hubei",
            "L": "Wuhan",
            "O": "system:kube-scheduler",
            "OU": "system"
```

} ]

}

注: hosts 列表包含所有 kube-scheduler 节点 IP; CN 为 system:kube-scheduler、O 为 system:kube-scheduler，kubernetes 内置的 ClusterRoleBindings system:kube-scheduler 将赋予 kube-scheduler 工作所需的权限。

\#生成证书

[root@xianchaomaster1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca- config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler

\#创建 kube-scheduler 的 kubeconfig
 1.设置集群参数
 [root@xianchaomaster1 work]# kubectl config set-cluster kubernetes --certificate-

```
authority=ca.pem --embed-certs=true --server=https://192.168.40.180:6443 --kubeconfig=kube-
scheduler.kubeconfig
```

2.设置客户端认证参数

[root@xianchaomaster1 work]# kubectl config set-credentials system:kube-scheduler -- client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=true --kubeconfig=kube-scheduler.kubeconfig

3.设置上下文参数

[root@xianchaomaster1 work]# kubectl config set-context system:kube-scheduler -- cluster=kubernetes --user=system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig

4.设置默认上下文

[root@xianchaomaster1 work]# kubectl config use-context system:kube-scheduler -- kubeconfig=kube-scheduler.kubeconfig

\#创建配置文件 kube-scheduler.conf
 [root@xianchaomaster1 work]# vim kube-scheduler.conf KUBE_SCHEDULER_OPTS="--address=127.0.0.1 \ --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

```
    --leader-elect=true \
    --alsologtostderr=true \
    --logtostderr=false \
    --log-dir=/var/log/kubernetes \
    --v=2"
```

\#创建服务启动文件
 [root@xianchaomaster1 work]# vim kube-scheduler.service [Unit]
 Description=Kubernetes Scheduler Documentation=https://github.com/kubernetes/kubernetes

```
    [Service]
    EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf
    ExecStart=/usr/local/bin/kube-scheduler $KUBE_SCHEDULER_OPTS
    Restart=on-failure
    RestartSec=5
    [Install]
    WantedBy=multi-user.target
```

\#启动服务
 [root@xianchaomaster1 work]# cp kube-scheduler*.pem /etc/kubernetes/ssl/ [root@xianchaomaster1 work]# cp kube-scheduler.kubeconfig /etc/kubernetes/ [root@xianchaomaster1 work]# cp kube-scheduler.conf /etc/kubernetes/ [root@xianchaomaster1 work]# cp kube-scheduler.service /usr/lib/systemd/system/ [root@xianchaomaster1 work]# systemctl daemon-reload
 [root@xianchaomaster1 work]# systemctl enable kube-scheduler [root@xianchaomaster1 work]# systemctl start kube-scheduler [root@xianchaomaster1 work]# systemctl status kube-scheduler
 ● kube-scheduler.service - Kubernetes Scheduler

```
       Active: active (running) since Wed
```

1. 3.6  导入离线镜像压缩包
    \#把 pause-cordns.tar.gz 上传到 xianchaonode1 节点，手动解压 [root@xianchaonode1 ~]# docker load -i pause-cordns.tar.gz
2. 3.7  部署 kubelet 组件
    以下操作在 xianchaomaster1 上操作
    创建 kubelet-bootstrap.kubeconfig
    [root@xianchaomaster1 work]# cd /data/work/
    [root@xianchaomaster1 work]# BOOTSTRAP_TOKEN=$(awk -F "," '{print $1}'

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
/etc/kubernetes/token.csv)
```

**韩先超老师微信:****luckylucky421302**

```
    [root@xianchaomaster1 work]#  kubectl config set-cluster kubernetes --certificate-
authority=ca.pem --embed-certs=true --server=https://192.168.40.180:6443 --
kubeconfig=kubelet-bootstrap.kubeconfig
```

[root@xianchaomaster1 work]# kubectl config set-credentials kubelet-bootstrap -- token=${BOOTSTRAP_TOKEN} --kubeconfig=kubelet-bootstrap.kubeconfig

[root@xianchaomaster1 work]# kubectl config set-context default --cluster=kubernetes -- user=kubelet-bootstrap --kubeconfig=kubelet-bootstrap.kubeconfig

[root@xianchaomaster1 work]# kubectl config use-context default --kubeconfig=kubelet- bootstrap.kubeconfig

```
    [root@xianchaomaster1 work]# kubectl create clusterrolebinding kubelet-bootstrap --
clusterrole=system:node-bootstrapper --user=kubelet-bootstrap
```

\#创建配置文件 kubelet.json
 "cgroupDriver": "systemd"要和 docker 的驱动一致。 address 替换为自己 xianchaonode1 的 IP 地址。

[root@xianchaomaster1 work]# vim kubelet.json {

```
      "kind": "KubeletConfiguration",
      "apiVersion": "kubelet.config.k8s.io/v1beta1",
      "authentication": {
        "x509": {
          "clientCAFile": "/etc/kubernetes/ssl/ca.pem"
        },
        "webhook": {
          "enabled": true,
          "cacheTTL": "2m0s"
        },
        "anonymous": {
          "enabled": false
```

} },

```
      "authorization": {
        "mode": "Webhook",
        "webhook": {
          "cacheAuthorizedTTL": "5m0s",
          "cacheUnauthorizedTTL": "30s"
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

} },

```
      "address": "192.168.40.181",
      "port": 10250,
      "readOnlyPort": 10255,
      "cgroupDriver": "systemd",
      "hairpinMode": "promiscuous-bridge",
      "serializeImagePulls": false,
      "featureGates": {
        "RotateKubeletClientCertificate": true,
        "RotateKubeletServerCertificate": true
      },
      "clusterDomain": "cluster.local.",
      "clusterDNS": ["10.255.0.2"]
    }
    [root@xianchaomaster1 work]# vim kubelet.service
    [Unit]
    Description=Kubernetes Kubelet
    Documentation=https://github.com/kubernetes/kubernetes
    After=docker.service
    Requires=docker.service
    [Service]
    WorkingDirectory=/var/lib/kubelet
    ExecStart=/usr/local/bin/kubelet \
      --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \
      --cert-dir=/etc/kubernetes/ssl \
      --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \
      --config=/etc/kubernetes/kubelet.json \
      --network-plugin=cni \
      --pod-infra-container-image=k8s.gcr.io/pause:3.2 \
      --alsologtostderr=true \
      --logtostderr=false \
      --log-dir=/var/log/kubernetes \
      --v=2
    Restart=on-failure
    RestartSec=5
    [Install]
    WantedBy=multi-user.target
```

\#注: –hostname-override:显示名称，集群中唯一

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

–network-plugin:启用 CNI –kubeconfig:空路径，会自动生成，后面用于连接 apiserver –bootstrap-kubeconfig:首次启动向 apiserver 申请证书 –config:配置参数文件
 –cert-dir:kubelet 证书生成目录 –pod-infra-container-image:管理 Pod 网络容器的镜像

\#注:kubelete.json 配置文件 address 改为各个节点的 ip 地址，在各个 work 节点上启动服务

```
    [root@xianchaonode1 ~]# mkdir /etc/kubernetes/ssl -p
```

[root@xianchaomaster1 work]# scp kubelet-bootstrap.kubeconfig kubelet.json xianchaonode1:/etc/kubernetes/

[root@xianchaomaster1 work]# scp ca.pem xianchaonode1:/etc/kubernetes/ssl/ [root@xianchaomaster1 work]# scp kubelet.service xianchaonode1:/usr/lib/systemd/system/

\#启动 kubelet 服务
 [root@xianchaonode1 ~]# mkdir /var/lib/kubelet [root@xianchaonode1 ~]# mkdir /var/log/kubernetes [root@xianchaonode1 ~]# systemctl daemon-reload [root@xianchaonode1 ~]# systemctl enable kubelet [root@xianchaonode1 ~]# systemctl start kubelet [root@xianchaonode1 ~]# systemctl status kubelet

```
   Active: active (running) since
```

确认 kubelet 服务启动成功后，接着到 xianchaomaster1 节点上 Approve 一下 bootstrap 请求。 执行如下命令可以看到 worker 节点发送了 CSR 请求:
 [root@xianchaomaster1 work]# kubectl get csr
 NAME AGE SIGNERNAME

```
REQUESTOR           CONDITION
    node-csr-SY6gROGEmH0qVZhMVhJKKWN3UaWkKKQzV8dopoIO9Uc   87s   kubernetes.io/kube-
apiserver-client-kubelet   kubelet-bootstrap   Pending
```

[root@xianchaomaster1 work]# kubectl certificate approve node-csr- SY6gROGEmH0qVZhMVhJKKWN3UaWkKKQzV8dopoIO9Uc

```
    [root@xianchaomaster1 work]# kubectl get csr
    NAME                                                   AGE     SIGNERNAME
REQUESTOR           CONDITION
```

node-csr-SY6gROGEmH0qVZhMVhJKKWN3UaWkKKQzV8dopoIO9Uc 2m25s kubernetes.io/kube- apiserver-client-kubelet kubelet-bootstrap Approved,Issued

```
    [root@xianchaomaster1 work]# kubectl get nodes
    NAME    STATUS     ROLES    AGE   VERSION
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302** xianchaonode1 NotReady <none> 40s v1.20.7

\#注意:STATUS 是 NotReady 表示还没有安装网络插件

3.8 部署 kube-proxy 组件 #创建 csr 请求

```
    [root@xianchaomaster1 work]# vim kube-proxy-csr.json
    {
      "CN": "system:kube-proxy",
      "key": {
        "algo": "rsa",
        "size": 2048
      },
```

"names": [ {

```
          "C": "CN",
          "ST": "Hubei",
          "L": "Wuhan",
          "O": "k8s",
          "OU": "system"
```

} ]

}

生成证书

```
    [root@xianchaomaster1 work]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-
config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy
```

\#创建 kubeconfig 文件

[root@xianchaomaster1 work]# kubectl config set-cluster kubernetes --certificate- authority=ca.pem --embed-certs=true --server=https://192.168.40.180:6443 --kubeconfig=kube- proxy.kubeconfig

```
    [root@xianchaomaster1 work]# kubectl config set-credentials kube-proxy --client-
certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=true --
kubeconfig=kube-proxy.kubeconfig
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302
** [root@xianchaomaster1 work]# kubectl config set-context default --cluster=kubernetes --

```
user=kube-proxy --kubeconfig=kube-proxy.kubeconfig
```

[root@xianchaomaster1 work]# kubectl config use-context default --kubeconfig=kube- proxy.kubeconfig

\#创建 kube-proxy 配置文件
 [root@xianchaomaster1 work]# vim kube-proxy.yaml apiVersion: kubeproxy.config.k8s.io/v1alpha1 bindAddress: 192.168.40.181
 clientConnection:

```
      kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig
    clusterCIDR: 192.168.40.0/24
    healthzBindAddress: 192.168.40.181:10256
    kind: KubeProxyConfiguration
    metricsBindAddress: 192.168.40.181:10249
    mode: "ipvs"
```

\#创建服务启动文件
 [root@xianchaomaster1 work]# vim kube-proxy.service [Unit]
 Description=Kubernetes Kube-Proxy Server Documentation=https://github.com/kubernetes/kubernetes After=network.target

```
    [Service]
    WorkingDirectory=/var/lib/kube-proxy
    ExecStart=/usr/local/bin/kube-proxy \
      --config=/etc/kubernetes/kube-proxy.yaml \
      --alsologtostderr=true \
      --logtostderr=false \
      --log-dir=/var/log/kubernetes \
      --v=2
    Restart=on-failure
    RestartSec=5
    LimitNOFILE=65536
    [Install]
    WantedBy=multi-user.target
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

[root@xianchaomaster1 work]# scp kube-proxy.kubeconfig kube-proxy.yaml xianchaonode1:/etc/kubernetes/

```
    [root@xianchaomaster1 work]#scp  kube-proxy.service
xianchaonode1:/usr/lib/systemd/system/
```

\#启动服务
 [root@xianchaonode1 ~]# mkdir -p /var/lib/kube-proxy [root@xianchaonode1 ~]# systemctl daemon-reload [root@xianchaonode1 ~]# systemctl enable kube-proxy [root@xianchaonode1 ~]# systemctl restart kube-proxy [root@xianchaonode1 ~]# systemctl status kube-proxy

```
       Active: active (running) since Wed
```

3.9 部署 calico 组件
 \#解压离线镜像压缩包
 \#把 cni.tar.gz 和 node.tar.gz 上传到 xianchaonode1 节点，手动解压 [root@xianchaonode1 ~]# docker load -i cni.tar.gz [root@xianchaonode1 ~]# docker load -i node.tar.gz

需要修改 calico.yaml 文件:
 \- name: IP_AUTODETECTION_METHOD

value: "can-reach=192.168.40.181 192.168.40.181 这个 ip 是 k8s 任何一个工作节点的 ip 都行

```
    [root@xianchaomaster1 work]# kubectl apply -f calico.yaml
    [root@xianchaomaster1 ~]# kubectl get pods -n kube-system
    NAME                READY   STATUS    RESTARTS   AGE
    calico-node-xk7n4   1/1     Running   0          13s
```

3.10 部署 coredns 组件
 [root@xianchaomaster1 ~]# kubectl apply -f coredns.yaml
 [root@xianchaomaster1 ~]# kubectl get pods -n kube-system
 NAME READY STATUS RESTARTS AGE
 calico-node-xk7n4 1/1 Running 0 6m6s coredns-7bf4bd64bd-dt8dq 1/1 Running 0 51s [root@xianchaomaster1 ~]# kubectl get svc -n kube-system
 NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 10.255.0.2 <none> 53/UDP,53/TCP,9153/TCP 12m

4.查看集群状态

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

[root@xianchaomaster1 ~]# kubectl get nodes NAME STATUS ROLES AGE VERSION xianchaonode1 Ready <none> 38m v1.20.7

5.测试 k8s 集群部署 tomcat 服务

\#把 tomcat.tar.gz 和 busybox-1-28.tar.gz 上传到 xianchaonode1，手动解压 [root@xianchaonode1 ~]# docker load -i tomcat.tar.gz [root@xianchaonode1 ~]# docker load -i busybox-1-28.tar.gz [root@xianchaomaster1 ~]# kubectl apply -f tomcat.yaml

```
    [root@xianchaomaster1 ~]# kubectl get pods
    NAME       READY   STATUS    RESTARTS   AGE
    demo-pod   2/2     Running   0          11m
    [root@xianchaomaster1 ~]# kubectl apply -f tomcat-service.yaml
    [root@xianchaomaster1 ~]# kubectl get svc
    NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE
    kubernetes   ClusterIP   10.255.0.1       <none>        443/TCP          158m
    tomcat       NodePort    10.255.227.179   <none>        8080:30080/TCP   19m
```

在浏览器访问 xianchaonode1 节点的 ip:30080 即可请求到浏览器

6.验证 cordns 是否正常

[root@xianchaomaster1 ~]# kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- sh

```
    / # ping www.baidu.com
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```

**韩先超老师微信:****luckylucky421302**

PING www.baidu.com (39.156.66.18): 56 data bytes
 64 bytes from 39.156.66.18: seq=0 ttl=127 time=39.3 ms #通过上面可以看到能访问网络
 / # nslookup kubernetes.default.svc.cluster.local Server: 10.255.0.2
 Address: 10.255.0.2:53
 Name: kubernetes.default.svc.cluster.local
 Address: 10.255.0.1

```
    / # nslookup tomcat.default.svc.cluster.local
    Server:    10.255.0.2
    Address 1: 10.255.0.2 kube-dns.kube-system.svc.cluster.local
    Name:      tomcat.default.svc.cluster.local
    Address 1: 10.255.227.179 tomcat.default.svc.cluster.local
```

\#注意:

busybox 要用指定的 1.28 版本，不能用最新版本，最新版本，nslookup 会解析不到 dns 和 ip，报错 如下:

/ # nslookup kubernetes.default.svc.cluster.local
 Server: 10.255.0.2
 Address: 10.255.0.2:53
 *** Can't find kubernetes.default.svc.cluster.local: No answer *** Can't find kubernetes.default.svc.cluster.local: No answer

10.255.0.2 就是我们 coreDNS 的 clusterIP，说明 coreDNS 配置好了。 解析内部 Service 的名称，是通过 coreDNS 去解析的。

```
版权声明，本文档全部内容及版权归韩先超所有，只可用于自己学习使用，禁止私自传阅，违者依法追
责。
```